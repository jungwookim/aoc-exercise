(ns aoc.2024.day14
  (:require [util.core :as u]))

(defn parse-robot [input]
  (let [pattern #"p=(-?\d+),(-?\d+) v=(-?\d+),(-?\d+)"
        matches (re-matches pattern input)]
    (when matches
      (let [[_ px py vx vy] matches]
        [[(Integer/parseInt px) (Integer/parseInt py)]
         [(Integer/parseInt vx) (Integer/parseInt vy)]]))))

(def infos
  (->> "resources/2024/input.txt"
       (u/read-input)
       (map parse-robot)))

(defn loc
  [x max-x]
  (cond
    (>= x max-x) (- x max-x)
    (neg? x) (+ max-x x)
    :else x))

(defn teleport
  [[p v max-w max-h]]
  (let [[px py] p
        [vx vy] v]
    [[(loc (+ px vx) max-w) (loc (+ py vy) max-h)] v max-w max-h]))


(defn n-teleport [n max-w max-h]
  (for [info infos]
    (nth (iterate teleport (-> info
                               (conj max-w)
                               (conj max-h))) n)))

(defn in-quadrants
  [[px py] max-w max-h]
  (let [half-w (quot max-w 2)
        half-h (quot max-h 2)]
    (cond
      (or (= half-w px)
          (= half-h py)) :border
      (and (> half-w px)
           (< half-h py)) :3
      (and (> half-w px)
           (> half-h py)) :4
      (and (< half-w px)
           (> half-h py)) :2
      (and (< half-w px)
           (< half-h py)) :1)))

(defn nth-positions [n max-w max-h]
  (->> (n-teleport n max-w max-h)
       (map first)))

(defn part1 [n max-w max-h]
  (->> (nth-positions n max-w max-h)
       (map #(in-quadrants % max-w max-h))
       (remove #(= % :border))
       frequencies
       vals
       (reduce *)))

(defn part2 [start max-w max-h]
  (let [result (->> (nth-positions start max-w max-h)
                    frequencies
                    vals
                    (remove #(= 1 %))
                    empty?)]
    (if result
      start
      (recur (inc start) max-w max-h))))

(comment
  (part1 100 101 103)
  ;; 230900224
  (part2 0 101 103)
  ;; 6532

  (def grid
    (mapv (fn [_]
            (mapv (constantly ".") (range 110))) (range 110)))
  grid

  (nth-positions 6532 101 103)
  (doseq [line (map #(clojure.string/join "" %) (reduce (fn [acc-grid [px py]]
                                                          (update-in acc-grid [py px] (constantly "#"))) grid (nth-positions 6532 101 103)))]
    (println line)))

; ......................................................................................#.......................
; ..............................................................#...............................................
; ....................................................#................#........................................
; ..............................................................................................................
; ..............................................................................................................
; .............#..........................................................#.............#............#..........
; ..........#................................#.....#...................#.............................#..........
; ..............................................................................................................
; .....................#.........#..............................................................................
; .........#....................................................................................................
; ....................#............................................#............................................
; ..............................................................................................................
; ..........#.........................#..............................#........#.................................
; ..............................................................................................................
; ..............................................................................................................
; .................................................................................#............................
; .......#...................................................................................#..................
; ..............................................................................................................
; ..............................................................................................................
; ......................................................................................#..#....................
; ..............................................................................................................
; .....................................................#........................................................
; ..............................................................................................................
; ...................#..........................................................................................
; ..............#....................................##.................#.......................................
; ..........................................#..........................................#........................
; ............................................................#...................#.............................
; .......................#......................................................................................
; .................##............................................#...#..........................................
; .................................................#............................................................
; ..............................................................................................................
; ........................###############################.......................................................
; ...............#........#.............................#.......................................................
; ........................#.............................#........................#..............................
; ..............#.........#.............................#.......................................................
; ........................#.............................#.......................................................
; ........................#..............#..............#..........................#...#........................
; ........................#.............###.............#......................#................................
; ......#.................#............#####............#.......................................................
; ........................#...........#######...........#...................#...................................
; .......#............#...#..........#########..........#.............................................#.........
; ........................#............#####............#.......................................................
; .#......................#...........#######...........#...................................#...................
; ........................#..........#########..........#.....................#.................................
; ........................#.........###########.........#.......................................................
; ........................#........#############........#.......................................................
; ........................#..........#########..........#.......................................................
; ......#.................#.........###########.........#....................................#........#.........
; ........................#........#############........#.......................................................
; ...........#............#.......###############.......#.......................................................
; ........................#......#################......#.......................................................
; ........................#........#############........#.......................................................
; ........................#.......###############.......#.......................................................
; ........................#......#################......#..#....................................................
; ........................#.....###################.....#...........................................#...........
; ........................#....#####################....#..................#..#.................................
; ........................#.............###.............#.......................................................
; ........................#.............###.............#.......................................................
; ........................#.............###.............#........................................#..............
; .#......................#.............................#..#....................................................
; ....#...................#.............................#............#..........................................
; ......#.....#...........#.............................#.......................#...............................
; ........................#.............................#..............................#........................
; ........................###############################.................#.....................................
; ........................................................................#.....................................
; ......................................#..........................#............................................
; .............................................................................................#................
; .........................................#....................................................................
; ...............................................................................................#..............
; .....................................................................................#..........#.............
; .....................................#........................................................................
; .............#.......#........................................................................................
; ....#........................#...........................................................#....................
; .................#........#...................................................................................
; ..............#.................................................................#.............................
; ..............................................................................................................
; ..............................................................................................................
; ..............................................#..................#.........#..................................
; ........................#..........................#..........................................................
; ...#..........................................................................................................
; .......................................................#.........#............................................
; ..............#.#.....................#.......................................................................
; ......................................................#...............#.............#.........................
; ..........#.....................................#.............................................................
; ..............................................................................................................
; ...................................................................................#..........................
; .............................................................................#..........#.....................
; ......................................................#.......................................................
; ...................#.......................#...................#..............................................
; ................#..................................#..........................................................
; ................................................................................#.............................
; .....................................#.....................#..................................................
; ..............................................#...............................................................
; #..................................................................................#..........................
; .........#...........................................................#........#.....#.........................
; ..................#......................#........................#............#..............................
; ..................................#.....................................#.....................................
; .......................#....#.................................................#...............................
; ....................................................................................................#.........
; ...........................#....#.............................................................................
; ......#..............#...........................................................................#............
; ..............................................................#...............................................
; .......................................#.#..#.................................................................
; ..............................................................................................................
; ..............................................................................................................
; ..............................................................................................................
; ..............................................................................................................
; ..............................................................................................................
; ..............................................................................................................
; ..............................................................................................................